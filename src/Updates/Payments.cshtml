@using System.Collections.Generic
@using Dynamicweb.Rendering
@inherits RazorTemplateBase<RazorTemplateModel<Template>>

@{
    var supportedLocales = new HashSet<string>(
        new[] { "zh-CN", "zh-TW", "da-DK", "nl-NL", "en-US", "fi-FI", "fr-FR", "de-DE", "it-IT", "ja-JP", "ko-KR", "no-NO", "pl-PL", "pt-BR", "ru-RU", "es-ES", "sv-SE" },
        StringComparer.OrdinalIgnoreCase
    );
    var currentLocale = GetGlobalValue("Global:Area.Culture.Name");
    if (!supportedLocales.Contains(currentLocale))
    {
        currentLocale = "en-US";
    }
}

@*Integrity generated by https://www.srihash.org/ for 5.37.0 version*@
<script src="@GetString("Adyen.JavaScriptUrl")"
        integrity="sha384-TuqC1LaZ2iw0DlDrmluxE4vRttgTLNohEkxYPgwNvRX8c9wwHemZ/vxZC0O9tdoQ"
        crossorigin="anonymous"></script>

<link rel="stylesheet" href="@GetString("Adyen.CssUrl")"
      integrity="sha384-rK6FOZCL/OiCDgj87Rk5w7v8BBO2GGXpzIZcWUMqwJVPRBtx3rMrgamBlGOXvKsP"
      crossorigin="anonymous">

<div id="output" style="width: 100%;"></div>
<div id="dropin-container"></div>

<script>

    function GetBaseUrl() {
        return '/Default.aspx?ID=@GetGlobalValue("Global:Page.ID")&CheckoutHandlerOrderID=@GetString("Ecom:Order.ID")&redirect=false';
    }

    var configuration = {
        onSubmit: function (state, dropin) {
            dropin.setStatus('loading');
            var request = createRequest("POST", GetBaseUrl() + '&Action=SelectMethod');
            request.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    processResponse(this, dropin);
                }
            });

            request.send(JSON.stringify(state.data));
        },
        onAdditionalDetails: function (state, dropin) {
            dropin.setStatus('loading');
            var request = createRequest("POST", GetBaseUrl() + '&Action=GetAdditionalDetails');
            request.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    processResponse(this, dropin);
                }
            });

            request.send(JSON.stringify(state.data));
        },
        showPayButton: true,
        locale: '@currentLocale',
        environment: '@GetString("Adyen.Environment")',
        clientKey: '@GetString("Adyen.ClientKey")',
        session: {
            id: '@GetString("Adyen.PaymentSessionId")',
            sessionData: '@GetString("Adyen.PaymentSessionData")'
        },
        amount: {
            currency: '@GetString("Adyen.Currency")',
            value: @GetLong("Adyen.Price"),
        },
    };

    (async () => {
            const checkout = await AdyenCheckout(configuration);
            checkout.create('dropin').mount('#dropin-container');
    })();

    function createRequest(method, url) {
        var request = new XMLHttpRequest();
        request.responseType = "json";
        request.open(method, url, true);
        request.setRequestHeader('Content-Type', 'application/json');

        return request;
    }

    function processResponse(request, dropin) {
        dropin.setStatus('ready');

        var response = request.response;
        if (request.status !== 200 || !response) {
            showError("Something went wrong.");
            return;
        }

        if (response.redirectToReceipt) {
            // show payment result and redirect to receipt
            dropin.setStatus("success");
            setTimeout(function () {
                document.location = response.redirectToReceipt;
            }, 1500);
            return;
        }

        if (response.action) {
            dropin.handleAction(response.action);
        } else if (response.errorCode) {
            showError(response.message, dropin);
        } else {
            showError("Something went wrong.", dropin);
        }
    }

    function showError(message, dropin) {
        if (message && message.length > 0) {
            dropin.setStatus("error", { message: message });
        } else {
            dropin.setStatus("error");
        }
    }
</script>